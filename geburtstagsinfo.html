<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ‚ Geburtstage diese Woche</title>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }

    h1 {
      color: #333;
    }

    .slider {
      display: flex;
      overflow-x: auto;
      gap: 1rem;
      scroll-snap-type: x mandatory;
      padding: 1rem 0;
      justify-content: center;
      flex-wrap: wrap;
    }

    .slide {
      flex: 0 0 300px;
      background: white;
      border-radius: 20px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      scroll-snap-align: center;
      transition: transform 0.3s;
    }

    .slide:hover {
      transform: scale(1.03);
    }

    .slide.today {
      position: relative;
      border-radius: 20px;
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 10px 30px rgba(255, 197, 79, 0.18), 0 0 0 6px rgba(255, 213, 79, 0.06);
      transition: transform 300ms ease, box-shadow 300ms ease;
      z-index: 1;
      overflow: visible;
    }

    .slide.today::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: 24px;
      background: linear-gradient(90deg, rgba(255, 213, 79, 0.16), rgba(255, 183, 77, 0.28), rgba(255, 213, 79, 0.16));
      filter: blur(8px);
      z-index: -1;
      opacity: 0.95;
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
      pointer-events: none;
    }

    @keyframes shimmer {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .foto {
      width: 100%;
      height: 200px;
      border-radius: 15px;
      background: #ddd center/cover no-repeat;
      margin-bottom: 1rem;
    }

    #error {
      color: #800;
      margin-top: 1rem;
      display: none;
    }
  </style>
</head>

<body>

  <h1>ðŸŽ‚ Geburtstage diese Woche</h1>
  <div id="error" role="alert"></div>
  <div id="output" class="slider"></div>

  <!-- load SheetJS to parse .xlsx in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    const MEDIA_BASE_URL = 'http://localhost:5000/files';

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const resp = await fetch(`${MEDIA_BASE_URL}/geburtstage.xlsx`);
        if (!resp.ok) throw new Error('Datei nicht gefunden');
        const arrayBuffer = await resp.arrayBuffer();
        const rows = parseXLSX(arrayBuffer);
        handleRows(rows);
      } catch (err) {
        showError('XLSX konnte nicht geladen werden: ' + err.message);
      }
    });

    function parseXLSX(buffer) {
      const data = new Uint8Array(buffer);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[firstSheet];
      // Convert sheet to array of objects using first row as headers
      const rows = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
      return rows;
    }

    function handleRows(rows) {
      try {
        const heute = new Date();

        // Wochentag: Montag = 1 ... Sonntag = 7
        const wochentagHeute = heute.getDay() === 0 ? 7 : heute.getDay();
        const diffToMonday = wochentagHeute - 1;
        const monday = new Date(heute);
        monday.setDate(heute.getDate() - diffToMonday);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        const geburtstage = rows.filter(r => {
          const einwilligung = r["Welche Informationen dÃ¼rfen wir fÃ¼r die Anzeige verwenden?"]?.trim();
          if (einwilligung === "ðŸ”´ Keine Anzeige: Ich mÃ¶chte nicht, dass diese Information verÃ¶ffentlicht wird.") return false;

          const geb = parseDate(r["Geburtsdatum"]);
          if (!geb || isNaN(geb.getTime())) return false;

          // Wir setzen das Jahr auf das aktuelle Jahr, um den Wochentag zu prÃ¼fen
          const gebAktuellJahr = new Date(heute.getFullYear(), geb.getMonth(), geb.getDate());
          return gebAktuellJahr >= monday && gebAktuellJahr <= sunday;
        });

        renderGeburtstage(geburtstage);
      } catch (err) {
        showError('Fehler beim Verarbeiten der XLSX: ' + err.message);
      }
    }

    function handleFileContent(text) {
      try {
        const rows = parseCSV(text, ';');
        const heute = new Date();

        // Wochentag: Montag = 1 ... Sonntag = 7
        const wochentagHeute = heute.getDay() === 0 ? 7 : heute.getDay();
        const diffToMonday = wochentagHeute - 1;
        const monday = new Date(heute);
        monday.setDate(heute.getDate() - diffToMonday);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        const geburtstage = rows.filter(r => {
          const einwilligung = r["Welche Informationen dÃ¼rfen wir fÃ¼r die Anzeige verwenden?"]?.trim();
          if (einwilligung === "ðŸ”´ Keine Anzeige: Ich mÃ¶chte nicht, dass diese Information verÃ¶ffentlicht wird.") return false;

          const geb = parseDate(r["Geburtsdatum"]);
          if (!geb || isNaN(geb.getTime())) return false;

          // Wir setzen das Jahr auf das aktuelle Jahr, um den Wochentag zu prÃ¼fen
          const gebAktuellJahr = new Date(heute.getFullYear(), geb.getMonth(), geb.getDate());
          return gebAktuellJahr >= monday && gebAktuellJahr <= sunday;
        });

        renderGeburtstage(geburtstage);
      } catch (err) {
        showError('Fehler beim Verarbeiten der CSV: ' + err.message);
      }
    }

    function parseCSV(text, delimiter = ';') {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines[0].split(delimiter).map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split(delimiter).map(v => v.trim());
        const row = {};
        headers.forEach((h, i) => row[h] = values[i] ?? "");
        return row;
      });
    }

    function renderGeburtstage(geburtstage) {
      const output = document.getElementById("output");
      const error = document.getElementById("error");
      output.innerHTML = "";
      error.style.display = "none";

      // sort birthdays by month/day within the current year
      geburtstage.sort((a, b) => {
        const da = parseDate(a["Geburtsdatum"]);
        const db = parseDate(b["Geburtsdatum"]);
        if (!da || !db) return 0;
        const now = new Date();
        const d1 = new Date(now.getFullYear(), da.getMonth(), da.getDate());
        const d2 = new Date(now.getFullYear(), db.getMonth(), db.getDate());
        return d1 - d2;
      });

      if (geburtstage.length === 0) {
        output.innerHTML = "<p>Diese Woche hat niemand Geburtstag ðŸŽ‰</p>";
        return;
      }

      const weekdays = ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"];

      geburtstage.forEach(p => {
        const einwilligung = p["Welche Informationen dÃ¼rfen wir fÃ¼r die Anzeige verwenden?"];
        const slide = document.createElement("div");
        slide.className = "slide";

        const filename = p["Dateiname Foto"]?.trim();
        const fotoUrl = filename ? `${MEDIA_BASE_URL}/${filename}` : null;
        const placeholderUrl = `${MEDIA_BASE_URL}/anonymous.jpg`;

        const geb = parseDate(p["Geburtsdatum"]);
        const gebAktuellJahr = new Date(new Date().getFullYear(), geb.getMonth(), geb.getDate());
        const weekday = weekdays[gebAktuellJahr.getDay()];

        let html = `<h3>${p.Name}</h3>
                <p>Geburtstag: ${weekday}, ${formatDate(p["Geburtsdatum"]).slice(0, -5)}</p>`;

        // mark if birthday is today (day+month)
        const now = new Date();
        const isToday = geb && geb.getDate() === now.getDate() && (geb.getMonth() + 1) === (now.getMonth() + 1);
        if (isToday) {
          slide.classList.add('today');
        }

        // Create the foto div and check if the image exists
        let fotoDiv = document.createElement('div');
        fotoDiv.className = 'foto';
        if (einwilligung?.startsWith("ðŸŸ¢") && fotoUrl) {
          // Try to load the image, fallback to anonymous.jpg if it fails
          let img = new window.Image();
          img.onload = function() {
            fotoDiv.style.backgroundImage = `url('${fotoUrl}')`;
          };
          img.onerror = function() {
            fotoDiv.style.backgroundImage = `url('${placeholderUrl}')`;
          };
          img.src = fotoUrl;
          // Set fallback first, will be replaced if image loads
          fotoDiv.style.backgroundImage = `url('${placeholderUrl}')`;
          html = fotoDiv.outerHTML + html;
        } else if (einwilligung?.startsWith("ðŸŸ¡")) {
          fotoDiv.style.backgroundImage = `url('${placeholderUrl}')`;
          html = fotoDiv.outerHTML + html;
        }

        slide.innerHTML = html;
        output.appendChild(slide);
      });
    }

    function formatDate(dateStr) {
      const d = parseDate(dateStr);
      return d && !isNaN(d.getTime()) ? d.toLocaleDateString('de-DE') : String(dateStr || '');
    }

    function parseDate(value) {
      if (!value) return null;
      if (value instanceof Date) return value;
      if (typeof value === 'number' && isFinite(value)) {
        const excelEpoch = new Date(1899, 11, 30);
        return new Date(excelEpoch.getTime() + value * 86400000);
      }
      const s = String(value).trim();
      const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})$/);
      if (m) {
        const [, d, mo, y] = m.map(Number);
        const year = y < 100 ? (y >= 70 ? 1900 + y : 2000 + y) : y;
        return new Date(year, mo - 1, d);
      }
      const parsed = new Date(s);
      return !isNaN(parsed.getTime()) ? parsed : null;
    }

    function showError(msg) {
      const err = document.getElementById("error");
      err.textContent = msg;
      err.style.display = "block";
    }
  </script>

</body>

</html>
